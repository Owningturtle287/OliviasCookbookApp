<!DOCTYPE html>

<html data-theme="system" lang="en">
<head>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<meta content="#ffffff" name="theme-color"/>
<title>Olivia‚Äôs Pocket Cookbook ‚Äî Stage 5 (Folders Fix)</title>
<link href="./manifest.webmanifest" rel="manifest"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="default" name="apple-mobile-web-app-status-bar-style"/>
<!-- Cute title font -->
<link href="https://fonts.googleapis.com" rel="preconnect"/><link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&amp;family=Caveat:wght@500;700&amp;display=swap" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&amp;display=swap" rel="stylesheet"/>
<style>
/* === COZY COOKBOOK SKIN (visuals only) === */
/* Keeps all IDs, classes, and behavior intact */

/* GLOBAL */
* { box-sizing: border-box; }
:root{
  /* Base palette: warm, bookish */
  --bg: #faf7f2;            /* paper */
  --card: #fffdf9;          /* card stock */
  --text: #2b1e16;          /* espresso ink */
  --muted: #7c6b5c;         /* sepia */
  --accent: #c86b39;        /* cinnamon */
  --danger: #b94a48;        /* vintage red */
  --chip: #f2e8da;          /* label */
  --chipText: #4f3e31;
  --shadow: 0 10px 22px rgba(62, 41, 23, .10);
  --radius: 16px;
  --overlay: rgba(34, 22, 15, .55);
  --input: rgba(34, 22, 15, .06);
  --border: rgba(62, 41, 23, .18);
  --today: #ffeaa3;         /* sticky-note yellow */
}

/* Respect system dark while staying cozy */
@media (prefers-color-scheme: dark) {
  :root{
    --bg: #171411;
    --card: #201a16;
    --text: #f3eee6;
    --muted: #c7b7a6;
    --accent: #ffb076;
    --danger: #ff7d6f;
    --chip: #2a231e;
    --chipText: #f3eee6;
    --shadow: 0 10px 26px rgba(0,0,0,.55);
    --overlay: rgba(0,0,0,.6);
    --input: rgba(255,255,255,.06);
    --border: rgba(255,255,255,.14);
    --today: #3a2f1f;
  }
}

/* Explicit theme toggles your app already uses */
[data-theme="light"]{
  --bg:#faf7f2; --card:#fffdf9; --text:#2b1e16; --muted:#7c6b5c; --accent:#c86b39; --danger:#b94a48;
  --chip:#f2e8da; --chipText:#4f3e31; --shadow:0 10px 22px rgba(62,41,23,.10); --overlay:rgba(34,22,15,.55);
  --input:rgba(34,22,15,.06); --border:rgba(62,41,23,.18); --today:#ffeaa3;
}
[data-theme="dark"]{
  --bg:#171411; --card:#201a16; --text:#f3eee6; --muted:#c7b7a6; --accent:#ffb076; --danger:#ff7d6f;
  --chip:#2a231e; --chipText:#f3eee6; --shadow:0 10px 26px rgba(0,0,0,.55); --overlay:rgba(0,0,0,.6);
  --input:rgba(255,255,255,.06); --border:rgba(255,255,255,.14); --today:#3a2f1f;
}

/* Paper texture background (pure CSS, lightweight) */
html,body{
  margin:0; padding:0; height:100%;
  color:var(--text);
  background:
    radial-gradient(1000px 600px at 10% -10%, rgba(255,255,255,.55), rgba(255,255,255,0)) ,
    radial-gradient(1200px 800px at 120% 0%, rgba(255,255,255,.3), rgba(255,255,255,0)),
    repeating-linear-gradient(0deg, rgba(0,0,0,.015) 0 2px, transparent 2px 4px),
    var(--bg);
  font-family: "Lora", Georgia, "Times New Roman", serif;
  -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
}

/* Links */
a.link{ color:var(--accent); text-decoration:none; font-weight:700; }
a.link:hover{ text-decoration:underline; }

.subtle{ color:var(--muted); font-size:12px; }
.spacer{ height:8px; }

/* Top bar ‚Äî stitched strip */
.appbar{
  position: sticky; top: env(safe-area-inset-top); z-index: 8;
  display:grid; grid-template-columns: 40px 1fr 40px; align-items:center; gap:8px;
  padding: calc(10px + env(safe-area-inset-top)) 12px 12px 12px;
  background:
    linear-gradient(180deg, rgba(0,0,0,.05), rgba(0,0,0,0)) ,
    var(--bg);
  backdrop-filter: saturate(140%) blur(8px);
  border-bottom: 1px dashed var(--border);
}
.appbar::after{
  content:""; position:absolute; inset:auto 12px 0 12px; height:6px;
  background: repeating-linear-gradient(90deg, rgba(0,0,0,.08) 0 6px, transparent 6px 14px);
  opacity:.25; border-radius:3px;
}
.iconbtn{ appearance:none; border:0; background:transparent; padding:6px; border-radius:10px; }
.iconbtn:active{ opacity:.6; }

/* Cozy title */
.title{
  text-align:center; font-size:26px; letter-spacing:.2px;
  font-family: 'Pacifico', 'Lora', cursive;
  color: var(--accent);
  text-shadow: 0 1px 0 rgba(255,255,255,.35);
}

/* Search ‚Äî rounded pill with inset look */
.searchWrap{ grid-column: 1 / 4; display:flex; justify-content:center; padding: 4px 0 0; }
.search{
  width:min(720px, 92vw); display:flex; align-items:center; gap:10px;
  background: var(--card);
  border:1px solid var(--border); border-radius: 999px; padding: 10px 14px;
  box-shadow: inset 0 2px 8px rgba(0,0,0,.04), var(--shadow);
}
.search input{ flex:1; border:0; outline:none; background:transparent; color:var(--text); font-size:16px; }
.search .count{ font-size:12px; color:var(--muted); }

/* Views */
.view{ display:none; padding: 12px 16px 120px 16px; }
.view.active{ display:block; }

/* Tab bar ‚Äî bookmark ribbons */
.tabbar{
  position: fixed; inset:auto 0 0 0; z-index: 9; background: var(--card);
  border-top:1px solid var(--border);
  display:flex; justify-content: space-around; align-items: center;
  padding: 8px calc(10px + env(safe-area-inset-bottom));
  box-shadow: 0 -10px 24px rgba(0,0,0,.10);
}
.tabbar button{
  position:relative;
  appearance:none; border:0; background:transparent;
  display:flex; flex-direction:column; align-items:center; gap:4px;
  padding:8px 12px; border-radius: 14px; color: var(--muted); font-size:12px; font-weight:700;
}
.tabbar button.active{
  color: var(--text); background: rgba(0,0,0,.04);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.15);
}
.tabbar button.active::after{
  content:""; position:absolute; bottom:-6px; left:50%; transform:translateX(-50%);
  width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent;
  border-top:6px solid currentColor; opacity:.6;
}
@media (prefers-color-scheme: dark){
  .tabbar button.active{ background: rgba(255,255,255,.06); }
}

/* Recipe list ‚Äî index cards */
.empty{ text-align:center; color:var(--muted); padding:60px 16px; }
ul.list{ list-style:none; margin:8px 0 0 0; padding:0; display:grid; gap:12px; }
.row{
  position:relative; background:var(--card); border-radius: var(--radius);
  border: 1px solid var(--border); box-shadow: var(--shadow);
  overflow:hidden; touch-action: pan-y;
}
.row .content{ display:flex; align-items:center; gap:12px; padding:12px; transition: transform .2s ease; will-change: transform; }
.thumb{
  width:64px; height:64px; border-radius:12px; object-fit:cover; background:#ddd; flex:0 0 64px;
  box-shadow: 0 3px 10px rgba(0,0,0,.06);
}
.name{ font-weight:800; font-size:17px; letter-spacing:.2px; }
.meta{ color:var(--muted); font-size:12px; margin-top:2px; font-style: italic; }
.tags{ margin-top:6px; }

/* Tags ‚Äî spice-label look */
.tag{
  display:inline-block;
  background:var(--chip);
  color:var(--chipText);
  padding:6px 12px 6px 28px;
  border-radius:999px;
  font-size:12px;
  margin:0 6px 6px 0;
  border: 1px dashed var(--border);
  position:relative;
}
.tag::before{
  content:""; width:6px; height:6px; border-radius:50%; background:var(--accent);
  position:absolute; left:6px; top:50%; transform:translateY(-50%);
  box-shadow: 0 0 0 2px var(--chip);
}

/* Swipe-to-delete stays the same visually */
.delete-btn{
  position:absolute; inset:0 0 0 auto; width:92px; border:0;
  background:var(--danger); color:white; font-weight:700;
  opacity:0; transform: translateX(92px); pointer-events:none;
  transition: opacity .15s ease, transform .15s ease;
}
.row.show-delete .content{ transform: translateX(-92px); }
.row.show-delete .delete-btn{ opacity:1; transform: translateX(0); pointer-events:auto; }

/* Buttons ‚Äî gentle gradients */
.btn{ appearance:none; border:1px solid var(--border); border-radius:12px; padding:12px 14px; font-weight:800; }
.btn.primary{
  background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 18%, white), var(--accent));
  color:white; text-shadow: 0 1px 0 rgba(0,0,0,.25);
  border-color: color-mix(in oklab, var(--accent) 70%, black);
  box-shadow: 0 6px 14px rgba(200,107,57,.25);
}
.btn.ghost{ background:var(--card); color:var(--text); }
.btn.danger{
  background: linear-gradient(180deg, color-mix(in oklab, var(--danger) 18%, white), var(--danger));
  color:white; border-color: color-mix(in oklab, var(--danger) 70%, black);
  box-shadow: 0 6px 14px rgba(185,74,72,.25);
}
.btn[disabled]{ opacity:.6; }

/* Floating Add ‚Äî ‚Äústicky‚Äù note */
.fab{
  position: fixed; left:16px; right:auto; bottom: calc(100px + env(safe-area-inset-bottom));
  background: var(--accent); color:white; border:0; padding:16px 18px; border-radius:24px; box-shadow: var(--shadow);
  font-weight:800; z-index: 12;
}
.fab::after{
  content:""; position:absolute; inset:-10px auto auto -8px; width:74px; height:20px;
  background: linear-gradient(180deg, #ffe4a8, #ffd27a);
  opacity:.9; transform: rotate(-4deg);
  border-radius:4px; box-shadow: 0 2px 6px rgba(0,0,0,.12);
}
.fab.hidden{ display:none; }
.fab:active{ transform: translateY(1px); }

/* Panels ‚Äî recipe cards with gentle tape */
.panel{
  position:relative; background:var(--card); border-radius:20px; box-shadow: var(--shadow); padding:16px; margin:8px 0 0 0;
  border: 1px solid var(--border);
}
.panel::before{
  content:""; position:absolute; width:72px; height:22px; left:18px; top:-10px;
  background: linear-gradient(180deg, #ffe4a8, #ffd27a);
  border-radius:4px; box-shadow: 0 2px 6px rgba(0,0,0,.12);
  transform: rotate(-2.5deg);
}
.panel h2{ margin:6px 0 10px 0; font-size:20px; }
.section{ margin-top:16px; }
.section h3{ margin:0 0 8px 0; }

/* Detail */
.hero{
  width:100%; aspect-ratio: 16/10; object-fit:cover; border-radius:16px; background:#ddd; box-shadow: 0 10px 24px rgba(0,0,0,.12);
  border: 1px solid var(--border);
}
.pill{
  display:inline-block; background:rgba(0,0,0,.04); padding:8px 10px; border-radius:999px; margin:0 8px 8px 0; border:1px dashed var(--border);
  font-family: "Caveat", "Lora", serif; font-size: 18px; letter-spacing:.2px;
}

/* Chips (editor) ‚Äî torn label vibe */
.chips{
  display:flex; gap:8px; flex-wrap: wrap; align-items: center; background:var(--card);
  border:1px dashed var(--border); border-radius:12px; padding:8px;
}
.chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  background:var(--chip);
  color:var(--chipText);
  border-radius:999px;
  padding:6px 12px;
  font-size:14px;
  border:1px solid var(--border);
  font-family: "Caveat", "Lora", serif;
}
.chip button{ border:0; background:transparent; color:inherit; font-weight:800; }
.chips input{ border:0; outline:none; min-width:120px; flex:1; font-size:16px; background:transparent; color:var(--text); }

/* Steps builder */
.stepRow{ display:flex; gap:8px; }
.stepRow input{
  flex:1; border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:transparent; color:var(--text);
  box-shadow: inset 0 2px 6px rgba(0,0,0,.04);
}
.stepsList{ list-style: decimal; padding-left: 22px; }
.stepsList li{ margin:8px 0; display:flex; gap:8px; align-items:flex-start; }
.stepText{ flex:1; }
.smIcon{ border:0; background:transparent; padding:5px; border-radius:8px; }
.smIcon:active{ opacity:.6; }

/* Inputs */
.input{
  width:100%; border:1px solid var(--border); border-radius:12px; padding:12px; background:transparent; color:var(--text);
  box-shadow: inset 0 2px 6px rgba(0,0,0,.04);
}

/* Sheets & Modal keep structure, just softer corners */
.sheet{
  position: fixed; inset:auto 0 0 0; transform: translateY(110%); transition: transform .2s ease; background: var(--card);
  border-top-left-radius: 16px; border-top-right-radius: 16px; box-shadow: 0 -10px 30px rgba(0,0,0,.25);
  padding: 10px 16px calc(16px + env(safe-area-inset-bottom)); z-index: 50;
}
.sheet.open{ transform: translateY(0); }
.grab{ width:48px; height:6px; border-radius:8px; background:rgba(127,127,127,.35); margin:8px auto 12px; }

.modal-backdrop{ position: fixed; inset:0; background: var(--overlay); z-index: 60; display:none; align-items:flex-end; justify-content:center; }
.modal-backdrop.open{ display:flex; }
.dialog{
  width: 100%; max-width: 540px; background: var(--card);
  border-top-left-radius: 16px; border-top-right-radius: 16px; padding: 16px; box-shadow: 0 -10px 30px rgba(0,0,0,.35);
}
.dialog h3{ margin:0 0 8px 0; }
.dialog p{ margin:0 0 12px 0; color:var(--muted); }
.dialog .rowbtns{ display:flex; gap:10px; justify-content:flex-end; }

/* Calendar ‚Äî notebook squares; today = sticky note */
.calHeader{ display:grid; grid-template-columns: auto 1fr auto; gap:8px; align-items:center; padding:8px 0; }
.calTitle{ font-weight:800; font-size: clamp(16px, 4.5vw, 22px); text-align:center; line-height: 1.1; }
.calNav{ display:flex; gap:8px; flex-wrap: wrap; }
.nowline{ font-size: clamp(11px, 3.4vw, 13px); color:var(--muted); text-align:right; }

.dow{
  display:grid; grid-template-columns: repeat(7, minmax(0,1fr)); gap:6px; margin-top:6px;
  color:var(--muted); font-weight:700; font-size: clamp(10px, 2.6vw, 12px);
}
.grid{
  display:grid; grid-template-columns: repeat(7, minmax(0,1fr)); gap:6px; margin-top:6px;
  grid-auto-rows: minmax(104px, auto);
}
.cell{
  background: var(--card);
  border:1px solid var(--border); border-radius: 12px; padding:8px; box-shadow: var(--shadow);
  display:flex; flex-direction:column; gap:6px; overflow:hidden;
  background-image: repeating-linear-gradient(0deg, rgba(0,0,0,.03) 0 2px, transparent 2px 28px);
}
.cell .daynum{ font-weight:800; font-size: clamp(10px, 2.4vw, 12px); color: var(--muted); align-self:flex-start; }
.cell.today{
  outline: 2px solid var(--accent);
  background: linear-gradient(180deg, color-mix(in oklab, var(--today) 92%, white), rgba(0,0,0,0)), var(--card);
}
.ev{
  display:block; max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  background:var(--chip); color:var(--chipText); border-radius:999px; padding:4px 8px; font-size: clamp(10px, 2.6vw, 12px);
}
.more{ font-size: clamp(10px, 2.6vw, 12px); color:var(--muted); }

/* Added UI styles */
:root { --success: #22c55e; }
.listItemCheck{ width:18px; height:18px; margin-right:8px; accent-color: var(--success); vertical-align: middle; }
#listViewItems .row.done .name, #listItemsList .row.done .name { text-decoration: line-through; color: var(--muted); }
.priceInput{ width:90px; padding:6px 8px; border:1px solid var(--border); border-radius:10px; background:transparent; color:var(--text); margin-left:auto; text-align:right; }
.ingList{ margin:6px 0 0 0; padding-left:18px; }
.ingList li{ list-style: disc; margin:2px 0; color: var(--text); }
li.divider{ border-top:1px dotted var(--border); margin:10px 0 6px; padding-top:6px; list-style:none; }
li.divider .sectionNote{ font-size:12px; color:var(--muted); margin-top:2px; }
</style>
<script>if ("serviceWorker" in navigator){window.addEventListener("load",()=>navigator.serviceWorker.register("./sw.js"));}</script>
<link href="https://owningturtle287.github.io/OliviasCookbookApp/icons/icon-180.png?v=3" rel="apple-touch-icon" sizes="180x180"/>
<link href="https://owningturtle287.github.io/OliviasCookbookApp/apple-touch-icon.png?v=3" rel="apple-touch-icon"/>
<style>
/* Prevent iOS zoom-on-focus by ensuring >=16px */
input, select, textarea, .input { font-size: 16px; }
/* Allow long lists to scroll while editing or viewing */
#listSheet, #listViewSheet { max-height: 92vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
/* Make items list not overflow horizontally */
#listItemsList, #listViewItems { overflow-x: hidden; }
/* Ensure bottom buttons stay reachable with on-screen keyboard */
#listSheet .btn.primary, #listViewSheet .btn.primary { touch-action: manipulation; }
</style>
</meta></head>
<body>
<header class="appbar">
<button aria-label="Back" class="iconbtn" id="backBtn" style="visibility:hidden" title="Back">
<svg aria-hidden="true" fill="none" height="26" viewbox="0 0 24 24" width="26"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
</button>
<div class="title" id="appTitle">Olivia‚Äôs Pocket Cookbook</div>
<!-- Open-book icon opens Settings -->
<button aria-label="Settings" class="iconbtn" id="settingsBtn" title="Settings">
<svg aria-hidden="true" fill="none" height="26" viewbox="0 0 24 24" width="26">
<path d="M3 5.5C3 4.12 4.12 3 5.5 3H11v16H5.5A2.5 2.5 0 013 16.5v-11z" fill="none" stroke="currentColor" stroke-width="1.7"></path>
<path d="M21 5.5C21 4.12 19.88 3 18.5 3H13v16h5.5a2.5 2.5 0 002.5-2.5v-11z" fill="none" stroke="currentColor" stroke-width="1.7"></path>
<path d="M11 6H7.5A2.5 2.5 0 005 8.5v0" stroke="currentColor" stroke-linecap="round" stroke-width="1.4"></path>
<path d="M13 6h3.5A2.5 2.5 0 0119 8.5v0" stroke="currentColor" stroke-linecap="round" stroke-width="1.4"></path>
</svg>
</button>
<!-- Centered Search (visible on List view only) -->
<div class="searchWrap" id="searchWrap">
<div class="search">
<svg aria-hidden="true" fill="none" height="18" viewbox="0 0 24 24" width="18"><path d="M21 21l-4.2-4.2" stroke="currentColor" stroke-linecap="round" stroke-width="2"></path><circle cx="10" cy="10" r="6" stroke="currentColor" stroke-width="2"></circle></svg>
<input id="searchInput" placeholder="Search recipes or keywords‚Ä¶" type="search"/>
<div class="count" id="resultCount"></div>
</div>
</div>
</header>
<!-- Views -->
<main aria-live="polite" class="view active" id="listView">
<div id="listContainer"></div>
</main>
<main class="view" id="detailView">
<div class="panel">
<div class="hero-wrap" id="detailCarousel" style="position:relative; overflow:hidden; border-radius:12px;">
<img alt="Recipe image" class="hero" id="detailImage" style="display:block; width:100%; height:auto;"/>
<button aria-label="Previous image" class="carBtn" id="carPrev" style="position:absolute;left:6px;top:50%;transform:translateY(-50%);border:none;background:rgba(0,0,0,0.35);color:#fff;font-size:22px;line-height:1;border-radius:24px;padding:8px 10px;cursor:pointer;display:none;">‚Äπ</button>
<button aria-label="Next image" class="carBtn" id="carNext" style="position:absolute;right:6px;top:50%;transform:translateY(-50%);border:none;background:rgba(0,0,0,0.35);color:#fff;font-size:22px;line-height:1;border-radius:24px;padding:8px 10px;cursor:pointer;display:none;">‚Ä∫</button>
<div id="carDots" style="position:absolute;left:0;right:0;bottom:6px;display:flex;gap:6px;justify-content:center;"></div>
</div>
<h2 id="detailName" style="margin-top:12px;"></h2>
<div class="subtle" id="detailMeta"></div>
<div class="section">
<h3>Ingredients</h3>
<div id="detailIngredients"></div>
</div>
<div class="section">
<h3>Cookware</h3>
<div id="detailCookware"></div>
</div>
<div class="section">
<h3>Steps</h3>
<ol id="detailSteps" style="padding-left:18px;margin:0;"></ol>
</div>
<div class="section">
<h3>Keywords</h3>
<div class="tags" id="detailKeywords"></div>
</div>
<div class="section">
<h3>Dates</h3>
<div class="tags" id="detailDates"></div>
<div class="row-inline" style="margin-top:8px;">
<input class="input" id="detailDateInput" type="date"/>
<button class="btn ghost" id="detailAddDate">Add date</button>
</div>
<div class="subtle">Assign another date to schedule this recipe.</div>
</div>
<div class="spacer"></div>
<div style="display:flex;gap:10px;justify-content:flex-end">
<button class="btn ghost" id="editBtn">Edit</button>
</div>
</div>
</main>
<main class="view" id="formView">
<form class="panel" id="recipeForm">
<h2 id="formTitle">Add Recipe</h2>
<input id="editingId" type="hidden" value=""/>
<div class="row-inline">
<div style="flex:1">
<label for="name">Name</label>
<input class="input" id="name" name="name" placeholder="e.g., Caprese Salad" required="" type="text"/>
</div>
</div>
<div class="section">
<h3>Photos (up to 3)</h3>
<div class="row-inline">
<div class="previewList" id="imagePreviewList" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
<div style="flex:1">
<input accept="image/*" id="image" multiple="" name="image" type="file"/>
<div class="subtle">Photos are compressed &amp; stored efficiently to save space.</div>
<div style="margin-top:6px"><label><input id="removeImage" type="checkbox"/> Remove images</label></div>
</div>
</div>
</div>
<div class="section">
<h3>Ingredients</h3>
<div aria-label="Ingredients chip input" class="chips" id="chipsIngredients"></div>
<div class="subtle">Type an item and hit Return to add.</div>
</div>
<div class="section">
<h3>Cookware</h3>
<div aria-label="Cookware chip input" class="chips" id="chipsCookware"></div>
</div>
<div class="section">
<h3>Steps</h3>
<div class="stepRow">
<input class="input" id="stepInput" placeholder="Add a step and tap +" style="height:auto;" type="text"/>
<button class="btn primary" id="addStepBtn" type="button">Ôºã</button>
</div>
<ol class="stepsList" id="stepsList"></ol>
</div>
<div class="section">
<h3>Keywords</h3>
<div aria-label="Keywords chip input" class="chips" id="chipsKeywords"></div>
<div class="subtle">Examples: vegetarian, quick, Italian</div>
</div>
<div class="section">
<h3>Calendar dates</h3>
<div class="row-inline" style="gap:8px;">
<input class="input" id="datePicker" style="max-width: 220px;" type="date"/>
<button class="btn ghost" id="addDateBtn" type="button">Add date</button>
</div>
<div aria-label="Dates chip input" class="chips" id="chipsDates" style="margin-top:8px;"></div>
<div class="subtle">Add multiple dates (e.g., meal plan days). Tap √ó to remove.</div>
</div>
<div class="spacer"></div>
<div style="display:flex;gap:10px;justify-content:flex-end">
<button class="btn ghost" id="cancelForm" type="button">Cancel</button>
<button class="btn primary" id="saveBtn" type="submit">Save Recipe</button>
</div>
</form>
</main>
<!-- Calendar view -->
<main class="view" id="calendarView">
<div class="panel">
<div class="calHeader">
<div class="calNav">
<button class="btn ghost" id="prevMonth">‚óÄ</button>
<button class="btn ghost" id="todayBtn">Today</button>
<button class="btn ghost" id="nextMonth">‚ñ∂</button>
</div>
<div class="calTitle" id="calTitle"></div>
<div class="nowline" id="nowLine">‚Äî</div>
</div>
<div class="dow">
<div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
</div>
<div class="grid" id="calGrid"></div>
</div>
</main>
<!-- Folders view -->
<main class="view" id="foldersView">
<div class="panel">
<div style="display:flex; align-items:center; gap:8px;">
<h2 style="margin:6px 0 10px 0; font-size:18px;">Folders</h2>
<button class="btn primary" id="newFolderBtn" style="margin-left:auto;">New Folder</button>
</div>
<ul class="folderGrid" id="foldersGrid"></ul>
<div class="empty" id="foldersEmpty" style="display:none;">No folders yet. Tap <b>New Folder</b> to create one.</div>
</div>
<div class="panel">
<div style="display:flex; align-items:center; gap:8px;">
<h2 style="margin:6px 0 10px 0; font-size:18px;">Lists</h2>
<button class="btn primary" id="newListBtn" style="margin-left:auto;">New List</button>
</div>
<ul class="list" id="listsList"></ul>
<div class="empty" id="listsEmpty" style="display:none;">No lists yet. Tap <b>New List</b> to create one.</div>
</div>
</main>
<!-- Folder detail view -->
<main class="view" id="folderDetailView">
<div class="panel">
<div style="display:flex; align-items:center; gap:8px;">
<h2 id="folderTitle" style="margin:6px 0 10px 0; font-size:18px;">Folder</h2>
<button class="btn ghost" id="renameFolderBtn" style="margin-left:auto;">Rename</button>
<button class="btn danger" id="deleteFolderBtn">Delete</button>
</div>
<div style="display:flex; gap:8px; margin-bottom:8px;">
<button class="btn primary" id="editFolderRecipesBtn">Add/Remove Recipes</button>
</div>
<ul class="list" id="folderRecipeList"></ul>
<div class="empty" id="folderEmpty" style="display:none;">No recipes in this folder yet.</div>
</div>
</main>
<!-- Tab Bar -->
<nav aria-label="Primary" class="tabbar" role="tablist">
<button aria-selected="true" class="active" id="tabRecipes" role="tab">
<svg aria-hidden="true" fill="none" height="22" viewbox="0 0 24 24" width="22"><path d="M4 7h16M4 12h16M4 17h10" stroke="currentColor" stroke-linecap="round" stroke-width="2"></path></svg>
      Recipes
    </button>
<button aria-selected="false" id="tabCalendar" role="tab">
<svg aria-hidden="true" fill="none" height="22" viewbox="0 0 24 24" width="22"><rect height="18" rx="2" stroke="currentColor" stroke-width="2" width="18" x="3" y="4"></rect><path d="M16 2v4M8 2v4M3 10h18" stroke="currentColor" stroke-linecap="round" stroke-width="2"></path></svg>
      Calendar
    </button>
<button aria-selected="false" id="tabFolders" role="tab">
<svg aria-hidden="true" fill="none" height="22" viewbox="0 0 24 24" width="22">
<path d="M3 7a2 2 0 012-2h4l2 2h8a2 2 0 012 2v7a2 2 0 01-2 2H5a2 2 0 01-2-2V7z" fill="none" stroke="currentColor" stroke-width="2"></path>
</svg>
      Folders and Lists
    </button>
</nav>
<button aria-label="Add recipe" class="fab" id="addBtn">Ôºã</button>
<!-- Settings sheet -->
<section aria-hidden="true" aria-labelledby="settingsTitle" aria-modal="true" class="sheet" id="settings" role="dialog">
<div aria-hidden="true" class="grab"></div>
<h2 id="settingsTitle" style="margin:0 0 6px 0;">Settings</h2>
<div class="panel">
<h3>Appearance</h3>
<div class="row-inline">
<button class="btn ghost" id="themeLight">Light</button>
<button class="btn ghost" id="themeDark">Dark</button>
<button class="btn ghost" id="themeSystem">Use System</button>
</div>
<div class="subtle">Your choice is saved on this device.</div>
</div>
<div class="panel">
<div class="panel">
<h3>Import / Export</h3>
<div class="row-inline" style="gap:8px; flex-wrap:wrap;">
<button class="btn" id="btnExport">Export (.json with images)</button>
<button class="btn" id="btnImport">Import (.json)</button>
<input accept="application/json" id="importFile" style="display:none" type="file"/>
</div>
<div class="subtle" style="margin-top:6px;">
    Exports your recipes, folders, lists, and photos to a single JSON file. Importing adds new items by ID and saves photos locally.
  </div>
</div>
<h3>Danger zone</h3>
<button class="btn danger" id="clearAll">Clear all recipes</button>
<div class="subtle" style="margin-top:6px;">This wipes recipes, photos, and folders from this device.</div>
</div>
<div class="spacer"></div>
<button class="btn ghost" id="closeSettings" style="width:100%;">Close</button>
</section>
<!-- Day Sheet (tap a calendar day) -->
<section aria-hidden="true" aria-labelledby="daySheetTitle" aria-modal="true" class="sheet" id="daySheet" role="dialog">
<div aria-hidden="true" class="grab"></div>
<h2 id="daySheetTitle" style="margin:0 0 6px 0;">Day</h2>
<div class="panel">
<ul class="dayList" id="dayList"></ul>
<div class="panel" id="dayActionsPanel" style="display:none; margin-top:8px;">
<button class="btn" id="addDayIngredientsBtn">Add Ingredients to Shopping List</button>
<button class="btn ghost" id="addToExistingListBtn" style="margin-top:6px;">Add Ingredients to Existing List</button>
</div>
</div>
<div class="spacer"></div>
<button class="btn ghost" id="closeDaySheet" style="width:100%;">Close</button>
</section>
<!-- Select Recipes sheet (for folders) -->
<section aria-hidden="true" aria-labelledby="selectTitle" aria-modal="true" class="sheet" id="selectSheet" role="dialog">
<div aria-hidden="true" class="grab"></div>
<h2 id="selectTitle" style="margin:0 0 6px 0;">Select Recipes</h2>
<div class="panel">
<ul class="selectList" id="selectList"></ul>
</div>
<div class="spacer"></div>
<div style="display:flex; gap:10px;">
<button class="btn ghost" id="cancelSelect" style="flex:1;">Cancel</button>
<button class="btn primary" id="saveSelect" style="flex:2;">Save Selection</button>
</div>
</section>
<!-- Folder Create/Rename sheet (fix for New Folder button) -->
<section aria-hidden="true" aria-labelledby="folderSheetTitle" aria-modal="true" class="sheet" id="folderSheet" role="dialog">
<div aria-hidden="true" class="grab"></div>
<h2 id="folderSheetTitle" style="margin:0 0 6px 0;">New Folder</h2>
<div class="panel">
<label class="subtle" for="folderNameInput">Name</label>
<input class="input" id="folderNameInput" placeholder="e.g., Weeknight Dinners" type="text"/>
</div>
<div class="spacer"></div>
<div style="display:flex; gap:10px;">
<button class="btn ghost" id="folderCancel" style="flex:1;">Cancel</button>
<button class="btn primary" id="folderSave" style="flex:2;">Save</button>
</div>
</section>
<section aria-hidden="true" aria-labelledby="listSheetTitle" aria-modal="true" class="sheet" id="listSheet" role="dialog">
<div aria-hidden="true" class="grab"></div>
<h2 id="listSheetTitle" style="margin:0 0 6px 0;">New List</h2>
<div class="panel">
<label class="subtle" for="listNameInput">List name</label>
<input class="input" id="listNameInput" placeholder="e.g., Groceries" type="text"/>
</div>
<div class="panel">
<h3>Add items</h3>
<div class="row-inline" style="display:flex; gap:8px; align-items:flex-end;">
<div style="flex:2;">
<label class="subtle" for="listItemInput">Item</label>
<input class="input" id="listItemInput" placeholder="e.g., Tomatoes" type="text"/>
</div>
<div style="flex:1; min-width:120px;">
<label class="subtle" for="listPriceInput">Price</label>
<input class="input" id="listPriceInput" min="0" placeholder="0.00" step="0.01" type="number"/>
</div>
<button class="btn ghost" id="addListItemBtn" style="height:44px;" type="button">Ôºã</button>
</div>
<ul class="list" id="listItemsList" style="margin-top:10px;"></ul>
<div class="subtle">Tap üóë to remove an item.</div>
</div>
<div class="spacer"></div>
<div style="display:flex; gap:10px;">
<button class="btn ghost" id="listCancel" style="flex:1;">Cancel</button>
<button class="btn primary" id="listSave" style="flex:2;">Save</button>
</div>
</section>
<section aria-hidden="true" aria-labelledby="listViewTitle" aria-modal="true" class="sheet" id="listViewSheet" role="dialog">
<div aria-hidden="true" class="grab"></div>
<h2 id="listViewTitle" style="margin:0 0 6px 0;">List</h2>
<div class="panel">
<div class="subtle">Total</div>
<div id="listViewTotal" style="font-size:18px; font-weight:700;">$0.00</div>
</div>
<div class="panel">
<h3 style="margin-top:0;">Items</h3>
<div id="listViewColumnsHead" style="display:flex; align-items:center; font-size:12px; margin:-4px 0 8px 0;">
<div style="flex:1; color:var(--muted);">Items</div>
<div style="width:90px; text-align:right; color:var(--muted);">Price</div>
</div>
<ul class="list" id="listViewItems"></ul>
</div>
<div class="spacer"></div>
<button class="btn primary" id="listViewClose">Close</button>
</section>
<section aria-hidden="true" aria-labelledby="addToListTitle" aria-modal="true" class="sheet" id="addToListSheet" role="dialog">
<div aria-hidden="true" class="grab"></div>
<h2 id="addToListTitle" style="margin:0 0 6px 0;">Add to Existing List</h2>
<div class="panel">
<div class="subtle" style="margin-bottom:8px;">Choose a list to append these ingredients.</div>
<ul class="list" id="addToListChoices"></ul>
</div>
<div class="spacer"></div>
<button class="btn" id="addToListCancel">Cancel</button>
</section>

<!-- Modal confirmation -->
<div aria-hidden="true" class="modal-backdrop" id="modal">
<div aria-labelledby="dialogTitle" aria-modal="true" class="dialog" role="dialog">
<h3 id="dialogTitle">Confirm</h3>
<p id="dialogMsg"></p>
<div class="rowbtns">
<button class="btn ghost" id="dlgCancel">Cancel</button>
<button class="btn danger" id="dlgOK">Yes</button>
</div>
</div>
</div>
<script>
    // --- THEME ---
    const THEME_KEY = 'pocketCookbook.theme';
    function applyTheme(t){
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem(THEME_KEY, t);
    }
    (function initTheme(){
      const saved = localStorage.getItem(THEME_KEY) || 'system';
      applyTheme(saved);
    })();

    // --- Storage Keys ---
    const STORAGE_KEY = 'pocketCookbook.recipes.v4';
    const FOLDERS_KEY = 'pocketCookbook.folders.v1';
    const LISTS_KEY = 'pocketCookbook.lists.v1';
    let db = null;

    function loadRecipes(){
      try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; }
      catch(e){ console.warn('Failed to load recipes', e); return []; }
    }
    function saveRecipes(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

    function loadFolders(){
      try{ const raw = localStorage.getItem(FOLDERS_KEY); return raw ? JSON.parse(raw) : []; }
      catch(e){ console.warn('Failed to load folders', e); return []; }
    }
    function saveFolders(list){ localStorage.setItem(FOLDERS_KEY, JSON.stringify(list)); }

    function loadLists(){
      try{ const raw = localStorage.getItem(LISTS_KEY); return raw ? JSON.parse(raw) : []; }
      catch(e){ console.warn('Failed to load lists', e); return []; }
    }
    function saveLists(list){ localStorage.setItem(LISTS_KEY, JSON.stringify(list)); }

    // IndexedDB minimal wrapper
    function openDB(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open('cookbookDB', 1);
        req.onupgradeneeded = (e) => {
          const dbc = e.target.result;
          if (!dbc.objectStoreNames.contains('images')){
            dbc.createObjectStore('images', { keyPath: 'id' });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    function idbPutImage(id, blob){
      return new Promise((resolve, reject) => {
        const tx = db.transaction('images', 'readwrite');
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
        tx.objectStore('images').put({ id, blob });
      });
    }
    function idbGetImage(id){
      return new Promise((resolve, reject) => {
        const tx = db.transaction('images', 'readonly');
        tx.onerror = () => reject(tx.error);
        const req = tx.objectStore('images').get(id);
        req.onsuccess = () => resolve(req.result ? req.result.blob : null);
        req.onerror = () => reject(req.error);
      });
    }
    function idbDeleteImage(id){
      return new Promise((resolve, reject) => {
        const tx = db.transaction('images', 'readwrite');
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
        tx.objectStore('images').delete(id);
      });
    }
    function idbClearAll(){
      return new Promise((resolve, reject) => {
        const tx = db.transaction('images', 'readwrite');
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
        tx.objectStore('images').clear();
      });
    }

    // Image helpers
    function dataURLtoBlob(dataUrl){
      const arr = dataUrl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]); let n = bstr.length; const u8 = new Uint8Array(n);
      while(n--){ u8[n] = bstr.charCodeAt(n); }
      return new Blob([u8], {type: mime});
    }
    function resizeImageFileToBlob(file, maxDim = 1200, quality = 0.8){
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > h && w > maxDim){ h = Math.round(h * (maxDim / w)); w = maxDim; }
            else if (h > maxDim){ w = Math.round(w * (maxDim / h)); h = maxDim; }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            if (canvas.toBlob){
              canvas.toBlob(b => resolve(b || file), 'image/jpeg', quality);
            } else {
              try{
                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                resolve(dataURLtoBlob(dataUrl));
              }catch(e){ resolve(file); }
            }
          };
          img.onerror = () => resolve(file);
          img.src = fr.result;
        };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    // Helpers
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m])); }
    function pad(n){ return n < 10 ? '0'+n : ''+n; }
    function toISODate(d){ return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
    function makePlaceholder(text='Recipe'){
      const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='500'>
        <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='#86b7ff'/><stop offset='100%' stop-color='#b2f5ea'/></linearGradient></defs>
        <rect width='100%' height='100%' fill='url(#g)'/>
        <text x='50%' y='52%' dominant-baseline='middle' text-anchor='middle' font-size='72' font-family='-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial' fill='white' opacity='0.95'>${text}</text>
      </svg>`);
      return `data:image/svg+xml;charset=utf-8,${svg}`;
    }

    // Custom confirm modal
    function confirmDialog(message, okText='Yes', danger=true){
      return new Promise(resolve => {
        const modal = $('#modal');
        $('#dialogMsg').textContent = message;
        const okBtn = $('#dlgOK'); const cancelBtn = $('#dlgCancel');
        okBtn.textContent = okText; okBtn.classList.toggle('danger', !!danger);
        function cleanup(ans){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); okBtn.removeEventListener('click', onOK); cancelBtn.removeEventListener('click', onCancel); modal.removeEventListener('click', onBackdrop); resolve(ans); }
        function onOK(){ cleanup(true); } function onCancel(){ cleanup(false); } function onBackdrop(e){ if(e.target === modal) cleanup(false); }
        okBtn.addEventListener('click', onOK); cancelBtn.addEventListener('click', onCancel); modal.addEventListener('click', onBackdrop);
        modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
      });
    }

    // Object URL cache to avoid leaks
    const urlCache = new Map(); // imageId -> objectURL
    async function setImgSrcFromImageId(imgEl, imageId, placeholder){
      if (!imageId){ imgEl.src = placeholder; return; }
      try{
        const blob = await idbGetImage(imageId);
        if (!blob){ imgEl.src = placeholder; return; }
        if (urlCache.has(imageId)){ URL.revokeObjectURL(urlCache.get(imageId)); }
        const url = URL.createObjectURL(blob);
        urlCache.set(imageId, url);
        imgEl.src = url;
      }catch{ imgEl.src = placeholder; }
    }

    // Chip input component
    function createChips(root){
      const values = [];
      const input = document.createElement('input');
      input.setAttribute('type','text');
      input.setAttribute('placeholder','Type and hit Return');
      root.appendChild(input);

      function render(){
        [...root.querySelectorAll('.chip')].forEach(n => n.remove());
        for (const v of values){
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.innerHTML = `${escapeHTML(v)} <button title="Remove" aria-label="Remove">√ó</button>`;
          chip.querySelector('button').onclick = () => {
            const idx = values.indexOf(v);
            if (idx >= 0){ values.splice(idx,1); render(); }
          };
          root.insertBefore(chip, input);
        }
      }
      function addFromInput(){
        const t = input.value.trim();
        if (!t) return;
        values.push(t);
        input.value='';
        render();
      }
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ','){ e.preventDefault(); addFromInput(); }
        else if (e.key === 'Backspace' && !input.value && values.length){
          values.pop(); render();
        }
      });
      input.addEventListener('blur', addFromInput);

      return {
        set(list){ values.splice(0, values.length, ...(list||[])); render(); },
        get(){ return values.slice(); },
        focus(){ input.focus(); },
        add(s){ if (s){ values.push(s); render(); } },
        remove(val){ const i = values.indexOf(val); if (i>=0){ values.splice(i,1); render(); } }
      };
    }

    // Steps builder
    function createSteps(listEl, inputEl){
      const steps = [];
      function render(){
        listEl.innerHTML = '';
        steps.forEach((txt, i) => {
          const li = document.createElement('li');
          const span = document.createElement('div');
          span.className = 'stepText'; span.textContent = txt;
          const edit = document.createElement('button');
          edit.className = 'smIcon'; edit.title='Edit'; edit.innerHTML = '‚úé';
          const del = document.createElement('button');
          del.className = 'smIcon'; del.title='Delete'; del.innerHTML = 'üóë';
          edit.onclick = async () => {
            const nv = prompt('Edit step', txt);
            if (nv !== null){ steps[i] = nv.trim(); render(); }
          };
          del.onclick = () => { steps.splice(i,1); render(); };
          li.appendChild(span); li.appendChild(edit); li.appendChild(del);
          listEl.appendChild(li);
        });
      }
      function add(s){
        const t = (s ?? inputEl.value).trim();
        if (!t) return;
        steps.push(t); inputEl.value=''; render();
      }
      return { set(list){ steps.splice(0, steps.length, ...(list||[])); render(); },
               get(){ return steps.slice(); },
               add };
    }

    // Dates chips specialized
    function createDateChips(root){
      const chips = createChips(root);
      return {
        set(list){ chips.set((list||[])); },
        get(){ return chips.get(); },
        addFromPicker(input){
          const val = input.value;
          if (!val) return;
          const arr = chips.get();
          if (!arr.includes(val)){ arr.push(val); chips.set(arr); }
          input.value = '';
        },
        remove(val){ chips.remove(val); }
      };
    }

    // --- State & Views ---
    let recipes = [];
    let folders = [];
    let lists = [];
    let currentId = null;
    let currentFolderId = null;
    let formMode = 'add';
    let searchQuery = '';

    const listView = $('#listView');
    const detailView = $('#detailView');
    const formView = $('#formView');
    const calendarView = $('#calendarView');
    const foldersView = $('#foldersView');
    const folderDetailView = $('#folderDetailView');
    const backBtn = $('#backBtn');
    const settings = $('#settings');
    const addBtn = $('#addBtn');
    const searchWrap = $('#searchWrap');
    const searchInput = $('#searchInput');
    const resultCount = $('#resultCount');
    const appTitle = $('#appTitle');

    // Day sheet refs
    const daySheet = $('#daySheet');
    const daySheetTitle = $('#daySheetTitle');
    const dayList = $('#dayList');
    $('#closeDaySheet').addEventListener('click', () => openDaySheet(null));

    // Folder selection sheet
    const selectSheet = $('#selectSheet');
    const selectList = $('#selectList');
    const saveSelect = $('#saveSelect');
    const cancelSelect = $('#cancelSelect');

    // Folder create/rename sheet
    const folderSheet = $('#folderSheet');
    const folderSheetTitle = $('#folderSheetTitle');
    const folderNameInput = $('#folderNameInput');
    const folderCancel = $('#folderCancel');
    const folderSave = $('#folderSave');
    let folderSheetMode = 'create'; // or 'rename'
    let folderSheetTargetId = null;

    // Lists panel & sheet refs
    const listsList = document.getElementById('listsList');
    const listsEmpty = document.getElementById('listsEmpty');
    const newListBtn = document.getElementById('newListBtn');

    const listSheet = document.getElementById('listSheet');
    const listSheetTitle = document.getElementById('listSheetTitle');
    const listNameInput = document.getElementById('listNameInput');
    const listItemInput = document.getElementById('listItemInput');
    const listPriceInput = document.getElementById('listPriceInput');
    const addListItemBtn = document.getElementById('addListItemBtn');
    const listItemsList = document.getElementById('listItemsList');
    const listCancel = document.getElementById('listCancel');
    const listSave = document.getElementById('listSave');
    let listSheetMode = 'create'; // or 'edit'
    let listSheetTargetId = null;
    let workingItems = [];

    // List view sheet
    const listViewSheet = document.getElementById('listViewSheet');
    const listViewTitle = document.getElementById('listViewTitle');
    const listViewTotal = document.getElementById('listViewTotal');
    const listViewItems = document.getElementById('listViewItems');
    const listViewClose = document.getElementById('listViewClose');

    // Chip instances
    const chipsIngredients = createChips($('#chipsIngredients'));
    const chipsCookware = createChips($('#chipsCookware'));
    const chipsKeywords = createChips($('#chipsKeywords'));
    const stepsBuilder = createSteps($('#stepsList'), $('#stepInput'));
    $('#addStepBtn').addEventListener('click', () => stepsBuilder.add());

    // Date chips
    const dateChips = createDateChips($('#chipsDates'));
    $('#addDateBtn').addEventListener('click', () => dateChips.addFromPicker($('#datePicker')));

    // Theme buttons
    $('#themeLight').addEventListener('click', () => applyTheme('light'));
    $('#themeDark').addEventListener('click', () => applyTheme('dark'));
    $('#themeSystem').addEventListener('click', () => applyTheme('system'));

    // Tabs
    const tabRecipes = $('#tabRecipes');
    const tabCalendar = $('#tabCalendar');
    const tabFolders = $('#tabFolders');
    tabRecipes.addEventListener('click', () => enterTab('recipes'));
    tabCalendar.addEventListener('click', () => enterTab('calendar'));
    tabFolders.addEventListener('click', () => enterTab('folders'));

    function enterTab(which){
      tabRecipes.classList.toggle('active', which==='recipes');
      tabRecipes.setAttribute('aria-selected', which==='recipes' ? 'true' : 'false');
      tabCalendar.classList.toggle('active', which==='calendar');
      tabCalendar.setAttribute('aria-selected', which==='calendar' ? 'true' : 'false');
      tabFolders.classList.toggle('active', which==='folders');
      tabFolders.setAttribute('aria-selected', which==='folders' ? 'true' : 'false');

      if (which==='recipes'){
        appTitle.textContent = 'Olivia‚Äôs Pocket Cookbook';
        show(listView);
        addBtn.classList.remove('hidden');
      } else if (which==='calendar'){
        appTitle.textContent = 'Calendar';
        show(calendarView);
        addBtn.classList.add('hidden');
        renderCalendar();
      } else {
        appTitle.textContent = 'Folders and Lists';
        show(foldersView);
        addBtn.classList.add('hidden');
        renderFolders();
        renderLists();
      }
    }

    function show(view){
      for (const v of [listView, detailView, formView, calendarView, foldersView, folderDetailView]) v.classList.remove('active');
      view.classList.add('active');
      const onList = (view === listView);
      backBtn.style.visibility = (view !== listView && view !== calendarView && view !== foldersView) ? 'visible' : 'hidden';
      searchWrap.style.display = onList ? 'flex' : 'none';
      $$('.row').forEach(r => r.classList.remove('show-delete'));
      window.scrollTo({top:0, behavior:'instant'});
    }

    // --- Recipes List ---
    function renderList(){
      const filtered = getFilteredRecipes();
      resultCount.textContent = filtered.length ? `${filtered.length}` : '';
      if (!filtered.length){
        $('#listContainer').innerHTML = `<div class="empty">
          <p>No recipes found.</p>
          <p class="subtle">Try another search or add a recipe.</p>
        </div>`;
        return;
      }
      const html = [`<ul class="list" id="recipeList">`];
      for (const r of filtered){
        const ingCount = (r.ingredients && r.ingredients.length) ? r.ingredients.length : 0;
        const stepCount = (r.steps && r.steps.length) ? r.steps.length : 0;
        const tags = (r.keywords || []).map(k => `<span class="tag">${escapeHTML(k)}</span>`).join('');
        html.push(`
          <li class="row" data-id="${r.id}" tabindex="0" aria-label="${escapeHTML(r.name)}">
            <button class="delete-btn" aria-label="Delete ${escapeHTML(r.name)}">Delete</button>
            <div class="content">
              <img class="thumb" data-image-id="${(Array.isArray(r.imageIds)&&r.imageIds.length?r.imageIds[0]:(r.imageId||''))}" alt="" src="${makePlaceholder('Recipe')}" />
              <div>
                <div class="name">${escapeHTML(r.name)}</div>
                <div class="meta">${ingCount} ingred ‚Ä¢ ${stepCount} steps</div>
                <div class="tags">${tags}</div>
              </div>
            </div>
          </li>
        `);
      }
      html.push(`</ul>`);
      $('#listContainer').innerHTML = html.join('');
      bindListEvents();
      hydrateListImages();
    }

    function hydrateListImages(){
      $$('#recipeList img.thumb').forEach(img => {
        const imageId = img.getAttribute('data-image-id');
        const placeholder = img.getAttribute('src');
        setImgSrcFromImageId(img, imageId, placeholder);
      });
    }

    function bindListEvents(){
      const rows = $$('#recipeList .row');
      rows.forEach(row => {
        const id = row.getAttribute('data-id');
        const content = row.querySelector('.content');
        const del = row.querySelector('.delete-btn');

        row.addEventListener('click', () => {
          if (row.classList.contains('show-delete')) return;
          openDetail(id);
        });

        del.addEventListener('click', async (e) => {
          e.stopPropagation();
          const r = recipes.find(r => r.id === id);
          if (!r) return;
          const ok = await confirmDialog(`Delete ‚Äú${r.name}‚Äù?`, 'Delete');
          if (ok){
            if (r.imageId){ try{ await idbDeleteImage(r.imageId); }catch{} }
            recipes = recipes.filter(r => r.id !== id);
            saveRecipes(recipes);
            // prune from folders
            folders.forEach(f => f.recipeIds = (f.recipeIds || []).filter(x => x !== id));
            saveFolders(folders);
            renderList();
          } else {
            row.classList.remove('show-delete');
          }
        });

        // Swipe gestures
        let startX = 0;
        let swiping = false;
        row.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; swiping = true; }, {passive:true});
        row.addEventListener('touchmove', (e) => {
          if (!swiping) return;
          const currentX = e.touches[0].clientX;
          const dx = Math.min(0, currentX - startX); // negative = left
          const translate = Math.max(-92, dx);
          content.style.transform = `translateX(${translate}px)`;
        }, {passive:true});
        row.addEventListener('touchend', () => {
          if (!swiping) return;
          swiping = false;
          const style = getComputedStyle(content);
          const transform = style.transform;
          let moved = 0;
          if (transform && transform !== 'none'){
            const m = new WebKitCSSMatrix(transform);
            moved = m.m41;
          }
          if (moved < -60) row.classList.add('show-delete');
          else row.classList.remove('show-delete');
          content.style.transform = '';
        }, {passive:true});
      });
    }

    async function openDetail(id){
      const r = recipes.find(x => x.id === id);
      if (!r) return;
      currentId = id;
      $('#detailName').textContent = r.name || 'Untitled';
      const ingCount = (r.ingredients && r.ingredients.length) ? r.ingredients.length : 0;
      const stepCount = (r.steps && r.steps.length) ? r.steps.length : 0;
      $('#detailMeta').textContent = `${ingCount} ingredients ‚Ä¢ ${stepCount} steps`;

      const pills = list => (list && list.length)
        ? list.map(i => `<span class="pill">${escapeHTML(i)}</span>`).join('')
        : '<div class="subtle">None</div>';
      $('#detailIngredients').innerHTML = pills(r.ingredients);
      $('#detailCookware').innerHTML = pills(r.cookware);

      const steps = r.steps && r.steps.length ? r.steps.map(s => `<li>${escapeHTML(s)}</li>`).join('') : '';
      $('#detailSteps').innerHTML = steps || '<div class="subtle">No steps</div>';

      const kw = (r.keywords || []).map(k => `<span class="tag">${escapeHTML(k)}</span>`).join('');
      $('#detailKeywords').innerHTML = kw || '<div class="subtle">None</div>';

      const dates = (r.dateEntries || []).slice().sort().map(d => `<span class="tag">${escapeHTML(d)}</span>`).join('');
      $('#detailDates').innerHTML = dates || '<div class="subtle">None</div>';

      const ids = getRecipeImageIds(r);
      carIds = ids.slice(); carIdx = 0;
      const imgEl = $('#detailImage');
      imgEl.src = makePlaceholder('Recipe');
      if (ids.length) await setImgSrcFromImageId(imgEl, ids[0], imgEl.src);
      updateCarUI();
      const wrap = $('#detailCarousel');
      const prevBtn = $('#carPrev'); const nextBtn = $('#carNext');
      if (prevBtn) prevBtn.onclick = () => carShow(carIdx - 1);
      if (nextBtn) nextBtn.onclick = () => carShow(carIdx + 1);
      if (wrap && !wrap.dataset.bound){
        let sx=0, dx=0, tracking=false;
        const finish = () => { if (!tracking) return; tracking=false; if (dx>40) carShow(carIdx-1); else if (dx<-40) carShow(carIdx+1); dx=0; };
        wrap.addEventListener('touchstart', (e)=>{ tracking=true; sx=e.touches[0].clientX; }, {passive:true});
        wrap.addEventListener('touchmove',  (e)=>{ if(!tracking) return; dx=e.touches[0].clientX - sx; }, {passive:true});
        wrap.addEventListener('touchend', finish, {passive:true});
        wrap.addEventListener('mousedown', (e)=>{ tracking=true; sx=e.clientX; });
        window.addEventListener('mousemove', (e)=>{ if(!tracking) return; dx=e.clientX - sx; });
        window.addEventListener('mouseup', finish);
        wrap.dataset.bound = '1';
      }

      show(detailView);
    }

    // Add date from detail
    $('#detailAddDate').addEventListener('click', () => {
      const inp = $('#detailDateInput');
      const val = inp.value;
      if (!currentId || !val) return;
      const r = recipes.find(x => x.id === currentId);
      if (!r) return;
      r.dateEntries = r.dateEntries || [];
      if (!r.dateEntries.includes(val)) r.dateEntries.push(val);
      saveRecipes(recipes);
      inp.value = '';
      openDetail(currentId);
    });

    // --- Search ---
    searchInput.addEventListener('input', () => {
      searchQuery = searchInput.value.trim().toLowerCase();
      renderList();
    });
    function getFilteredRecipes(){
      if (!searchQuery) return recipes.slice();
      return recipes.filter(r => {
        const bucket = [
          r.name || '',
          ...(r.ingredients || []),
          ...(r.cookware || []),
          ...(r.steps || []),
          ...(r.keywords || [])
        ].join(' ').toLowerCase();
        return bucket.includes(searchQuery);
      });
    }

    // --- Form flow (Add/Edit) ---
    $('#cancelForm').addEventListener('click', () => show(listView));
    $('#editBtn').addEventListener('click', () => enterEditMode(currentId));
    addBtn.addEventListener('click', () => enterAddMode());
    backBtn.addEventListener('click', () => show(listView));

    function enterAddMode(){
      formMode = 'add';
      $('#formTitle').textContent = 'Add Recipe';
      $('#saveBtn').textContent = 'Save Recipe';
      $('#editingId').value = '';
      $('#recipeForm').reset();
      $('#removeImage').checked = false;
      $('#image').value = '';
      renderFormPreviewsFromIds([]);
      chipsIngredients.set([]); chipsCookware.set([]); chipsKeywords.set([]);
      stepsBuilder.set([]);
      dateChips.set([]);
      show(formView);
    }

    async function enterEditMode(id){
      const r = recipes.find(x => x.id === id);
      if (!r) return;
      formMode = 'edit';
      $('#formTitle').textContent = 'Edit Recipe';
      $('#saveBtn').textContent = 'Save Changes';
      $('#editingId').value = r.id;
      $('#name').value = r.name || '';
      chipsIngredients.set(r.ingredients || []);
      chipsCookware.set(r.cookware || []);
      chipsKeywords.set(r.keywords || []);
      stepsBuilder.set(r.steps || []);
      dateChips.set(r.dateEntries || []);
      $('#removeImage').checked = false;
      await renderFormPreviewsFromIds(getRecipeImageIds(r));
      show(formView);
    }

    $('#recipeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const saveBtn = $('#saveBtn');
      const name = $('#name').value.trim();
      if (!name){ await confirmDialog('Please enter a name.', 'OK', false); return; }

      saveBtn.disabled = true;
      const prevLabel = saveBtn.textContent;
      saveBtn.textContent = 'Saving‚Ä¶';

      try {
        const fileInput = $('#image');
        const removeImage = $('#removeImage').checked;
        let newImageBlobs = [];
        if (fileInput && fileInput.files && fileInput.files.length){
          const sel = Array.from(fileInput.files).slice(0,3);
          if (fileInput.files.length > 3) alert('Only the first 3 photos will be used.');
          for (const f of sel) newImageBlobs.push(await resizeImageFileToBlob(f, 1200, 0.8));
        }

        if (formMode === 'add'){
          const recipe = {
            id: uid(),
            name,
            imageId: null,
            imageIds: [],
            ingredients: chipsIngredients.get(),
            cookware: chipsCookware.get(),
            steps: stepsBuilder.get(),
            keywords: chipsKeywords.get(),
            dateEntries: dateChips.get(),
            createdAt: Date.now()
          };
          if (newImageBlobs.length){
            for (const blob of newImageBlobs){ const imgId = uid(); await idbPutImage(imgId, blob); recipe.imageIds.push(imgId); }
            recipe.imageId = recipe.imageIds[0] || null;
          }
          recipes.unshift(recipe);
          saveRecipes(recipes);
          e.target.reset();
          renderList();
          show(listView);
        } else {
          const id = $('#editingId').value;
          const r = recipes.find(x => x.id === id);
          if (!r) throw new Error('Recipe not found.');
          r.name = name;
          r.ingredients = chipsIngredients.get();
          r.cookware = chipsCookware.get();
          r.steps = stepsBuilder.get();
          r.keywords = chipsKeywords.get();
          r.dateEntries = dateChips.get();

          let existing = getRecipeImageIds(r);
          if (removeImage && existing.length){ for (const id of existing){ try{ await idbDeleteImage(id); }catch{} } existing = []; }
          for (const blob of newImageBlobs){ if (existing.length >= 3) break; const id = uid(); await idbPutImage(id, blob); existing.push(id); }
          r.imageIds = existing.slice(0,3);
          r.imageId = r.imageIds[0] || null;
          saveRecipes(recipes);
          renderList();
          await openDetail(r.id);
          show(detailView);
        }
      } catch (err){
        await confirmDialog(err && err.message ? err.message : 'Could not save your recipe. Try a smaller photo or remove the image.', 'OK', false);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = prevLabel;
      }
    });

    

// ===== Multi-image & Import/Export helpers =====
function getRecipeImageIds(r){
  const list = Array.isArray(r.imageIds) ? r.imageIds.slice(0,3).filter(Boolean) : [];
  if (!list.length && r.imageId) list.push(r.imageId);
  return list.slice(0,3);
}
function getMainImageId(r){
  const ids = getRecipeImageIds(r);
  return ids.length ? ids[0] : null;
}

async function renderFormPreviewsFromIds(ids){
  const cont = $('#imagePreviewList');
  if (!cont) return;
  cont.innerHTML = '';
  for (const id of (ids||[])){
    try{
      const blob = await idbGetImage(id);
      if (!blob) continue;
      const url = URL.createObjectURL(blob);
      const img = document.createElement('img');
      img.className = 'preview';
      img.style.maxWidth = '120px';
      img.src = url;
      cont.appendChild(img);
      setTimeout(()=>URL.revokeObjectURL(url), 5000);
    }catch(_){}
  }
}

function showSelectedPreviews(files){
  const cont = $('#imagePreviewList');
  if (!cont) return;
  cont.innerHTML = '';
  files.slice(0,3).forEach(file => {
    const img = document.createElement('img');
    img.className = 'preview';
    img.style.maxWidth = '120px';
    const fr = new FileReader();
    fr.onload = () => img.src = fr.result;
    fr.readAsDataURL(file);
    cont.appendChild(img);
  });
}

// Hook change on file input
(() => {
  const el = document.getElementById('image');
  if (!el) return;
  el.addEventListener('change', (e) => {
    const files = Array.from(e.target.files || []);
    if (files.length > 3){
      alert('You can select up to 3 photos. Only the first 3 will be used.');
    }
    showSelectedPreviews(files);
  });
})();

// Carousel state + logic
let carIds = [];
let carIdx = 0;
function updateCarUI(){
  const prev = $('#carPrev'), next = $('#carNext'), dots = $('#carDots');
  if (!dots) return;
  dots.innerHTML = '';
  if (!carIds || carIds.length <= 1){
    if (prev) prev.style.display = 'none';
    if (next) next.style.display = 'none';
  } else {
    if (prev) prev.style.display = '';
    if (next) next.style.display = '';
  }
  for (let i=0;i<(carIds?carIds.length:0);i++){
    const dot = document.createElement('span');
    dot.style.cssText = 'width:8px;height:8px;border-radius:50%;background:' + (i===carIdx?'#fff':'rgba(255,255,255,0.5)') + ';display:inline-block;';
    dots.appendChild(dot);
  }
}
async function carShow(idx){
  if (!carIds || !carIds.length) return;
  carIdx = (idx + carIds.length) % carIds.length;
  const imgEl = $('#detailImage');
  const ph = imgEl.getAttribute('src') || makePlaceholder('Recipe');
  await setImgSrcFromImageId(imgEl, carIds[carIdx], ph);
  updateCarUI();
}

// ----- Import/Export with images -----
function dataURLtoBlob(dataUrl){
  const parts = dataUrl.split(',');
  const bstr = atob(parts[1]||'');
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while(n--){ u8arr[n] = bstr.charCodeAt(n); }
  const mime = (parts[0].match(/data:(.*?);base64/)||[])[1] || 'application/octet-stream';
  return new Blob([u8arr], { type: mime });
}
async function blobToDataURL(blob){
  return await new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = () => reject(fr.error);
    fr.readAsDataURL(blob);
  });
}
async function buildExportJSON(includeImages = true){
  const out = { version: 2, recipes, folders, lists };
  if (!includeImages) return out;
  const idSet = new Set();
  (recipes||[]).forEach(r => {
    if (Array.isArray(r.imageIds)) r.imageIds.forEach(id => id && idSet.add(id));
    else if (r.imageId) idSet.add(r.imageId);
  });
  const images = {};
  for (const id of idSet){
    try{
      const blob = await idbGetImage(id);
      if (blob) images[id] = await blobToDataURL(blob);
    }catch(_){}
  }
  out.images = images;
  return out;
}
async function doExport(){
  const data = await buildExportJSON(true);
  const json = JSON.stringify(data);
  const blob = new Blob([json], { type: 'application/json' });
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `cookbook-export-${ts}.json`;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => URL.revokeObjectURL(a.href), 1500);
  a.remove();
}
async function doImport(file){
  try{
    const text = await file.text();
    const parsed = JSON.parse(text);
    const imgs = parsed.images || {};
    const beforeR = recipes.length, beforeF = folders.length, beforeL = lists.length;
    function mergeById(existing, incoming){
      const ids = new Set((existing||[]).map(x => x.id));
      for (const item of (incoming||[])) if (!ids.has(item.id)){ existing.push(item); ids.add(item.id); }
      return existing;
    }
    recipes = mergeById(recipes, parsed.recipes || []);
    folders = mergeById(folders, parsed.folders || []);
    lists   = mergeById(lists,   parsed.lists   || []);
    saveRecipes(recipes); saveFolders(folders); saveLists(lists);
    const imageIds = new Set();
    (parsed.recipes || []).forEach(r => {
      if (Array.isArray(r.imageIds)) r.imageIds.forEach(id => id && imageIds.add(id));
      else if (r.imageId) imageIds.add(r.imageId);
    });
    for (const id of imageIds){
      const dataUrl = imgs[id];
      if (!dataUrl) continue;
      try{
        const blob = dataURLtoBlob(dataUrl);
        await idbPutImage(id, blob);
      }catch(_){}
    }
    renderList();
    await confirmDialog('Import complete. Added ' +
      (recipes.length - beforeR) + ' recipe(s), ' +
      (folders.length - beforeF) + ' folder(s), and ' +
      (lists.length - beforeL) + ' list(s).', 'OK', false);
  }catch(_){
    await confirmDialog('Import failed. Is that a valid cookbook JSON?', 'OK', false);
  } finally {
    const input = $('#importFile'); if (input) input.value = '';
  }
}
(() => {
  const btnExport = $('#btnExport');
  const btnImport = $('#btnImport');
  const fileInput = $('#importFile');
  if (btnExport) btnExport.addEventListener('click', () => doExport());
  if (btnImport) btnImport.addEventListener('click', () => fileInput && fileInput.click());
  if (fileInput) fileInput.addEventListener('change', (e) => {
    const f = e.target && e.target.files && e.target.files[0];
    if (f) doImport(f);
  });
})();

// --- Settings ---
    $('#settingsBtn').addEventListener('click', () => openSettings(true));
    $('#closeSettings').addEventListener('click', () => openSettings(false));
    function openSettings(open){
      settings.classList.toggle('open', !!open);
      settings.setAttribute('aria-hidden', open ? 'false' : 'true');
    }
    $('#clearAll').addEventListener('click', async () => {
      const ok = await confirmDialog('Clear all recipes and folders? This cannot be undone.', 'Clear all');
      if (ok){
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(FOLDERS_KEY);
        localStorage.removeItem(LISTS_KEY);
        recipes = [];
        folders = [];
        try{ await idbClearAll(); }catch{}
        renderList();
        enterTab('recipes');
        openSettings(false);
      }
    });

    // --- Calendar ---
    let calYear, calMonth;
    const calTitle = $('#calTitle');
    const calGrid = $('#calGrid');
    const nowLine = $('#nowLine');
    $('#prevMonth').addEventListener('click', () => { shiftMonth(-1); });
    $('#nextMonth').addEventListener('click', () => { shiftMonth(1); });
    $('#todayBtn').addEventListener('click', () => { const d = new Date(); calYear=d.getFullYear(); calMonth=d.getMonth(); renderCalendar(); });

    function shiftMonth(delta){
      calMonth += delta;
      if (calMonth < 0){ calMonth = 11; calYear -= 1; }
      else if (calMonth > 11){ calMonth = 0; calYear += 1; }
      renderCalendar();
    }

    function buildDateIndex(){
      const map = new Map();
      for (const r of recipes){
        const dates = (r.dateEntries || []);
        for (const d of dates){
          if (!map.has(d)) map.set(d, []);
          map.get(d).push({id:r.id, name:r.name});
        }
      }
      return map;
    }

    function renderCalendar(){
      const today = new Date();
      if (calYear == null || calMonth == null){
        calYear = today.getFullYear(); calMonth = today.getMonth();
      }
      const fmtMonth = new Intl.DateTimeFormat(undefined, {month:'long', year:'numeric'});
      calTitle.textContent = fmtMonth.format(new Date(calYear, calMonth, 1));

      const dateIndex = buildDateIndex();
      calGrid.innerHTML = '';

      const first = new Date(calYear, calMonth, 1);
      const startDay = first.getDay();
      const daysInMonth = new Date(calYear, calMonth+1, 0).getDate();
      const cells = [];

      for (let i=0;i<startDay;i++) cells.push({empty:true});
      for (let d=1; d<=daysInMonth; d++){
        const iso = calYear+'-'+pad(calMonth+1)+'-'+pad(d);
        const events = dateIndex.get(iso) || [];
        cells.push({day:d, iso, events});
      }

      for (const c of cells){
        const cell = document.createElement('div');
        cell.className = 'cell';
        if (c.empty){
          cell.style.visibility = 'hidden';
        }else{
          cell.setAttribute('data-iso', c.iso);
          const dn = document.createElement('div');
          dn.className = 'daynum';
          dn.textContent = c.day;
          cell.appendChild(dn);

          if (c.iso === toISODate(today)){
            cell.classList.add('today');
          }

          const maxShow = 4;
          c.events.slice(0,maxShow).forEach(ev => {
            const a = document.createElement('button');
            a.className = 'ev';
            a.textContent = ev.name;
            a.title = ev.name;
            a.onclick = (e) => { e.stopPropagation(); openDetail(ev.id); };
            cell.appendChild(a);
          });
          if (c.events.length > maxShow){
            const more = document.createElement('div');
            more.className = 'more';
            more.textContent = `+${c.events.length - maxShow} more`;
            cell.appendChild(more);
          }

          cell.addEventListener('click', () => openDaySheet(c.iso));
        }
        calGrid.appendChild(cell);
      }
      updateNowLine();
    }

    function openDaySheet(iso){
      if (!iso){
        daySheet.classList.remove('open');
        daySheet.setAttribute('aria-hidden','true');
        return;
      }
      const [y,m,d] = iso.split('-').map(n=>parseInt(n,10));
      const dateObj = new Date(y, m-1, d);
      const fmt = new Intl.DateTimeFormat(undefined, {weekday:'long', month:'long', day:'numeric', year:'numeric'});
      daySheetTitle.textContent = fmt.format(dateObj);

      const index = buildDateIndex();
      const events = index.get(iso) || [];
      
    // Day actions panel visibility
    const dayActionsPanel = document.getElementById('dayActionsPanel');
    if (dayActionsPanel) dayActionsPanel.style.display = events.length ? 'block' : 'none';
if (!events.length){
        dayList.innerHTML = `<li class="subtle" style="padding:10px 4px;">No recipes scheduled for this day.</li>`;
      } else {
        dayList.innerHTML = events.map(ev => `
          <li class="dayItem">
            <div>${escapeHTML(ev.name)}</div>
            <button class="btn ghost" data-open-id="${ev.id}">Open</button>
          </li>
        `).join('');
        dayList.querySelectorAll('button[data-open-id]').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-open-id');
            openDaySheet(null);
            openDetail(id);
          });
        });
      }

      
    // Render ingredient lists under each recipe title
    try{
      dayList.querySelectorAll('li.dayItem').forEach(li => {
        const btn = li.querySelector('button[data-open-id]');
        const id = btn ? btn.getAttribute('data-open-id') : null;
        if (!id) return;
        const r = recipes.find(x => x.id === id);
        const ing = (r && r.ingredients) ? r.ingredients : [];
        if (ing && ing.length){
          const ul = document.createElement('ul');
          ul.className = 'ingList';
          ul.innerHTML = ing.map(i => `<li>${escapeHTML(i)}</li>`).join('');
          li.appendChild(ul);
        }
      });
    }catch(e){ console.warn('augment day list failed', e); }

    // Wire day action buttons
    try{
      const addNewBtn = document.getElementById('addDayIngredientsBtn');
      const addToExisting = document.getElementById('addToExistingListBtn');
      if (addNewBtn){
        addNewBtn.onclick = () => {
          const uniq = new Map();
          for (const ev of events){
            const r = recipes.find(x => x.id === ev.id);
            (r && r.ingredients ? r.ingredients : []).forEach(raw => {
              const t = String(raw||'').trim(); if (!t) return;
              const k = t.toLowerCase(); if (!uniq.has(k)) uniq.set(k, t);
            });
          }
          const items = Array.from(uniq.values()).map(text => ({ text, price:0, done:false }));
          let dateLabel = iso;
          try{ const [y,m,d] = iso.split('-').map(n=>parseInt(n,10)); dateLabel = new Intl.DateTimeFormat(undefined,{month:'long',day:'numeric',year:'numeric'}).format(new Date(y,m-1,d)); }catch{}
          const L = { id: uid(), name: `Shopping List for ${dateLabel}`, items, createdAt: Date.now() };
          lists.unshift(L);
          saveLists(lists);
          renderLists();
          enterTab('folders');
          daySheet.classList.remove('open'); daySheet.setAttribute('aria-hidden','true');
        };
      }
      if (addToExisting){
        addToExisting.onclick = () => {
          const sections = [];
          let prettyDate = iso;
          try{ const [y,m,d] = iso.split('-').map(n=>parseInt(n,10)); prettyDate = new Intl.DateTimeFormat(undefined,{month:'long',day:'numeric',year:'numeric'}).format(new Date(y,m-1,d)); }catch{}
          for (const ev of events){
            const r = recipes.find(x => x.id === ev.id);
            if (!r) continue;
            const uniq = new Map();
            (r.ingredients||[]).forEach(raw => {
              const t = String(raw||'').trim(); if (!t) return;
              const k = t.toLowerCase(); if (!uniq.has(k)) uniq.set(k, t);
            });
            const items = Array.from(uniq.values()).map(text => ({ text, price:0, done:false }));
            sections.push({ note: `${prettyDate} ‚Ä¢ ${r.name||'Recipe'}`, items });
          }
          openAddToListSheet(sections);
        };
      }
    }catch(e){ console.warn('wire buttons failed', e); }



      daySheet.classList.add('open');
      daySheet.setAttribute('aria-hidden','false');
    }

    function updateNowLine(){
      const now = new Date();
      const fmt = new Intl.DateTimeFormat(undefined, {weekday:'short', month:'short', day:'numeric', hour:'numeric', minute:'2-digit'});
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
      $('#nowLine').textContent = fmt.format(now) + (tz ? ' ‚Ä¢ '+tz : '');
    }
    setInterval(updateNowLine, 60000);

    // --- Folders ---
    function renderFolders(){
      const grid = $('#foldersGrid');
      const empty = $('#foldersEmpty');
      grid.innerHTML = '';
      if (!folders.length){
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      for (const f of folders){
        const count = (f.recipeIds||[]).length;
        const li = document.createElement('li');
        li.className = 'folderCard';
        li.innerHTML = `
          <h3>${escapeHTML(f.name || 'Untitled')}</h3>
          <div class="folderMeta">${count} recipe${count===1?'':'s'}</div>
          <div class="folderActions">
            <button class="btn ghost" data-open="${f.id}">Open</button>
            <button class="btn ghost" data-edit="${f.id}">Rename</button>
          </div>
        `;
        grid.appendChild(li);

        li.querySelector('[data-open]').addEventListener('click', () => openFolder(f.id));
        li.querySelector('[data-edit]').addEventListener('click', () => openFolderSheet('rename', f.id));
      }
    }

    
    // --- Lists ---
    function renderLists(){
      if (!listsList) return;
      listsList.innerHTML = '';
      if (!lists || !lists.length){
        if (listsEmpty) listsEmpty.style.display = 'block';
        return;
      }
      if (listsEmpty) listsEmpty.style.display = 'none';
      
      for (const L of lists){
        const count = (L.items||[]).filter(it => !it || it.type !== 'section').length;
        const total = (L.items||[]).reduce((s,it)=> s + Number(it.price||0), 0);
        const li = document.createElement('li');
        li.className = 'row';
        li.setAttribute('data-id', L.id);
        li.innerHTML = `
          <button class="delete-btn" aria-label="Delete ${escapeHTML(L.name||'List')}">Delete</button>
          <div class="content">
            <div>
              <div class="name">${escapeHTML(L.name || 'Untitled')}</div>
              <div class="meta">$${total.toFixed(2)} ‚Ä¢ ${count} item${count===1?'':'s'}</div>
            </div>
            <div style="display:flex; gap:8px; margin-left:auto;">
              <button class="btn ghost" data-view="${L.id}">View</button>
              <button class="btn ghost" data-edit="${L.id}">Edit</button>
            </div>
          </div>
        `;
        listsList.appendChild(li);

        // View handler
        li.querySelector('[data-view]').addEventListener('click', (e)=>{ e.stopPropagation(); openListView(L.id); });

        // Edit handler
        li.querySelector('[data-edit]').addEventListener('click', (e)=>{ e.stopPropagation(); openListSheet('edit', L.id); });

        // Swipe-to-delete behavior similar to recipes
        const content = li.querySelector('.content');
        const delBtn = li.querySelector('.delete-btn');

        delBtn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const ok = await confirmDialog(`Delete list ‚Äú${L.name}‚Äù?`, 'Delete');
          if (!ok){ li.classList.remove('show-delete'); return; }
          lists = lists.filter(x => x.id !== L.id);
          saveLists(lists);
          renderLists();
        });

        let startX = 0; let swiping = false;
        li.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; swiping = true; }, {passive:true});
        li.addEventListener('touchmove', (e) => {
          if (!swiping) return;
          const currentX = e.touches[0].clientX;
          const dx = Math.min(0, currentX - startX);
          const translate = Math.max(-92, dx);
          content.style.transform = `translateX(${translate}px)`;
        }, {passive:true});
        li.addEventListener('touchend', () => {
          if (!swiping) return;
          swiping = false;
          const style = getComputedStyle(content);
          const transform = style.transform;
          let moved = 0;
          if (transform && transform !== 'none'){
            try{ const m = new WebKitCSSMatrix(transform); moved = m.m41; }catch{ moved = 0; }
          }
          if (moved < -60) li.classList.add('show-delete');
          else li.classList.remove('show-delete');
          content.style.transform = '';
        }, {passive:true});
      }
    }

    function openListSheet(mode='create', id=null){
      listSheetMode = mode;
      listSheetTargetId = id;
      if (mode === 'create'){
        listSheetTitle.textContent = 'New List';
        listNameInput.value = '';
        workingItems = [];
        listItemInput.value = '';
        listPriceInput.value = '';
      } else {
        const L = lists.find(x => x.id === id);
        listSheetTitle.textContent = 'Edit List';
        listNameInput.value = L ? (L.name || '') : '';
        workingItems = L ? (L.items ? L.items.slice() : []) : [];
        listItemInput.value = '';
        listPriceInput.value = '';
      }
      renderWorkingItems();
      listSheet.classList.add('open');
      listSheet.setAttribute('aria-hidden','false');
      setTimeout(()=>listNameInput.focus(), 50);
    }
    function closeListSheet(){
      listSheet.classList.remove('open');
      listSheet.setAttribute('aria-hidden','true');
    }
    function renderWorkingItems(){
      listItemsList.innerHTML = '';
      if (!workingItems.length){
        const empty = document.createElement('li');
        empty.className = 'subtle';
        empty.style.padding = '8px 4px';
        empty.textContent = 'No items yet.';
        listItemsList.appendChild(empty);
        return;
      }
      workingItems.forEach((it, idx) => {
        const li = document.createElement('li');
        li.className = 'row';
        li.innerHTML = `
          <div class="content" style="gap:10px;">
            <div class="name" style="font-size:15px; font-weight:700;">${escapeHTML(it.text)}</div>
            <div class="meta" style="margin-left:auto;">$${(Number(it.price)||0).toFixed(2)}</div>
            <button class="smIcon" title="Remove" aria-label="Remove">üóë</button>
          </div>
        `;
        li.querySelector('button').addEventListener('click', () => { workingItems.splice(idx,1); renderWorkingItems(); });
        listItemsList.appendChild(li);
      });
    }
    addListItemBtn && addListItemBtn.addEventListener('click', () => {
      const t = listItemInput.value.trim();
      const p = listPriceInput.value.trim();
      if (!t) return;
      workingItems.push({ id: uid(), text: t, price: Number(p||0) });
      listItemInput.value=''; listPriceInput.value='';
      renderWorkingItems();
    });
    listItemInput && listItemInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addListItemBtn.click(); }});
    listPriceInput && listPriceInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addListItemBtn.click(); }});

    newListBtn && newListBtn.addEventListener('click', () => openListSheet('create'));
    listCancel && listCancel.addEventListener('click', closeListSheet);
    listSave && listSave.addEventListener('click', () => {
      const name = (listNameInput.value || '').trim() || 'Untitled';
      if (listSheetMode === 'create'){
        const L = { id: uid(), name, items: workingItems.slice(), createdAt: Date.now() };
        lists.unshift(L);
      } else if (listSheetMode === 'edit' && listSheetTargetId){
        const L = lists.find(x => x.id === listSheetTargetId);
        if (L){ L.name = name; L.items = workingItems.slice(); }
      }
      saveLists(lists);
      renderLists();
      closeListSheet();
    })
    
function openListView(id){
  const L = lists.find(x => x.id === id);
  if (!L) return;
  const total = (L.items||[]).reduce((s,it)=> s + Number(it.price||0), 0);
  listViewTitle.textContent = L.name || 'List';
  listViewTotal.textContent = `$${total.toFixed(2)}`;
  listViewItems.innerHTML = '';
  if (!L.items || !L.items.length){
    const empty = document.createElement('li');
    empty.className = 'subtle';
    empty.style.padding = '8px 4px';
    empty.textContent = 'No items.';
    listViewItems.appendChild(empty);
  } else {
    L.items.forEach((it, idx) => {
      if (it && it.type === 'section'){
        const dli = document.createElement('li');
        dli.className = 'divider';
        dli.innerHTML = `<div class="sectionNote">${escapeHTML(it.note||'')}</div>`;
        listViewItems.appendChild(dli);
        return;
      }
      const li = document.createElement('li');
      li.className = 'row';
      const priceValue = Number(it.price||0);
      const priceStr = priceValue > 0 ? priceValue.toFixed(2) : '';
      li.innerHTML = `
        <div class="content" style="gap:10px; align-items:center;">
          <input type="checkbox" class="listItemCheck" title="Mark complete">
          <div class="name" style="font-size:15px; font-weight:700;">${escapeHTML(it.text)}</div>
          <input type="number" class="priceInput" step="0.01" min="0" placeholder="0.00" value="${priceStr}" inputmode="decimal">
        </div>
      `;
      const cb = li.querySelector('.listItemCheck');
      cb.checked = !!it.done;
      li.classList.toggle('done', cb.checked);
      cb.addEventListener('change', () => {
        if (!L.items[idx]) return;
        L.items[idx].done = cb.checked;
        li.classList.toggle('done', cb.checked);
        saveLists(lists);
      });
      const price = li.querySelector('.priceInput');
      const updateTotalAndSave = () => {
        if (!L.items[idx]) return;
        const val = parseFloat(price.value);
        L.items[idx].price = isNaN(val) ? 0 : val;
        const tot = (L.items||[]).reduce((s,ii)=> s + Number(ii.price||0), 0);
        listViewTotal.textContent = `$${tot.toFixed(2)}`;
        saveLists(lists);
        try{ renderLists(); }catch{}
      };
      price.addEventListener('focus', () => {
        if (price.value === '' || Number(price.value) === 0){ price.value = ''; } else { price.select(); }
      });
      price.addEventListener('change', updateTotalAndSave);
      price.addEventListener('blur', updateTotalAndSave);
      listViewItems.appendChild(li);
    });
  }
  listViewSheet.classList.add('open');
  listViewSheet.setAttribute('aria-hidden','false');
  if (listViewClose){
    const onClose = () => { try{ saveLists(lists); renderLists(); }catch{}; closeListView(); listViewClose.removeEventListener('click', onClose); };
    listViewClose.addEventListener('click', onClose);
  }
}

    function closeListView(){
      listViewSheet.classList.remove('open');
      listViewSheet.setAttribute('aria-hidden','true');
    }
    listViewClose && listViewClose.addEventListener('click', closeListView);
;
    function openFolder(id){
      const f = folders.find(x => x.id === id);
      if (!f) return;
      currentFolderId = id;
      $('#folderTitle').textContent = f.name || 'Untitled';
      renderFolderRecipes(id);
      show(folderDetailView);
    }

    function renderFolderRecipes(id){
      const f = folders.find(x => x.id === id);
      if (!f) return;
      const ul = $('#folderRecipeList');
      const empty = $('#folderEmpty');
      ul.innerHTML = '';
      const ids = new Set(f.recipeIds||[]);
      const items = recipes.filter(r => ids.has(r.id));
      if (!items.length){
        empty.style.display = 'block';
      }else{
        empty.style.display = 'none';
        for (const r of items){
          const li = document.createElement('li');
          li.className = 'row';
          li.innerHTML = `
            <div class="content">
              <img class="thumb" data-image-id="${(Array.isArray(r.imageIds)&&r.imageIds.length?r.imageIds[0]:(r.imageId||''))}" alt="" src="${makePlaceholder('Recipe')}" />
              <div>
                <div class="name">${escapeHTML(r.name)}</div>
                <div class="meta">${(r.ingredients||[]).length} ingred ‚Ä¢ ${(r.steps||[]).length} steps</div>
              </div>
              <button class="btn ghost" data-remove="${r.id}" style="margin-left:auto;">Remove</button>
            </div>`;
          ul.appendChild(li);
          const img = li.querySelector('img.thumb');
          setImgSrcFromImageId(img, r.imageId || '', img.getAttribute('src'));
          li.querySelector('[data-remove]').addEventListener('click', () => {
            f.recipeIds = (f.recipeIds||[]).filter(x => x !== r.id);
            saveFolders(folders);
            renderFolderRecipes(id);
          });
          li.addEventListener('click', (e)=>{ if(!(e.target instanceof HTMLButtonElement)) openDetail(r.id); });
        }
      }
      // bind header actions
      $('#renameFolderBtn').onclick = () => openFolderSheet('rename', f.id);
      $('#deleteFolderBtn').onclick = async () => {
        const ok = await confirmDialog(`Delete folder ‚Äú${f.name}‚Äù?`, 'Delete');
        if (!ok) return;
        folders = folders.filter(x => x.id !== id);
        saveFolders(folders);
        enterTab('folders');
      };
      $('#editFolderRecipesBtn').onclick = () => openSelectSheet(id);
    }

    // Folder sheet logic
    function openFolderSheet(mode='create', id=null){
      folderSheetMode = mode;
      folderSheetTargetId = id;
      if (mode === 'create'){
        folderSheetTitle.textContent = 'New Folder';
        folderNameInput.value = '';
      } else {
        const f = folders.find(x => x.id === id);
        folderSheetTitle.textContent = 'Rename Folder';
        folderNameInput.value = f ? (f.name || '') : '';
      }
      folderSheet.classList.add('open');
      folderSheet.setAttribute('aria-hidden','false');
      setTimeout(()=>folderNameInput.focus(), 50);
    }
    function closeFolderSheet(){
      folderSheet.classList.remove('open');
      folderSheet.setAttribute('aria-hidden','true');
    }
    $('#newFolderBtn').addEventListener('click', () => openFolderSheet('create'));
    folderCancel.addEventListener('click', closeFolderSheet);
    folderSave.addEventListener('click', () => {
      const name = folderNameInput.value.trim() || 'Untitled';
      if (folderSheetMode === 'create'){
        const folder = { id: uid(), name, recipeIds: [] };
        folders.unshift(folder);
        saveFolders(folders);
        renderFolders();
        renderLists();
      } else if (folderSheetMode === 'rename' && folderSheetTargetId){
        const f = folders.find(x => x.id === folderSheetTargetId);
        if (f){ f.name = name; saveFolders(folders); renderFolders(); if (currentFolderId === f.id) { $('#folderTitle').textContent = f.name; } }
      }
      closeFolderSheet();
    });
    folderNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter'){ e.preventDefault(); folderSave.click(); } });

    // Select sheet (multi-select recipes for a folder)
    function openSelectSheet(folderId){
      const f = folders.find(x => x.id === folderId);
      if (!f) return;
      selectList.innerHTML = '';
      const selected = new Set(f.recipeIds||[]);
      for (const r of recipes){
        const li = document.createElement('li');
        li.className = 'selectRow';
        li.innerHTML = `
          <img class="thumb" data-image-id="${(Array.isArray(r.imageIds)&&r.imageIds.length?r.imageIds[0]:(r.imageId||''))}" alt="" src="${makePlaceholder('Recipe')}" />
          <label><input type="checkbox" value="${r.id}" ${selected.has(r.id)?'checked':''}/> <span>${escapeHTML(r.name)}</span></label>
        `;
        selectList.appendChild(li);
        const img = li.querySelector('img.thumb');
        setImgSrcFromImageId(img, r.imageId || '', img.getAttribute('src'));
      }
      saveSelect.onclick = () => {
        const checks = selectList.querySelectorAll('input[type="checkbox"]');
        const chosen = [];
        checks.forEach(ch => { if (ch.checked) chosen.push(ch.value); });
        f.recipeIds = chosen;
        saveFolders(folders);
        selectSheet.classList.remove('open');
        selectSheet.setAttribute('aria-hidden','true');
        renderFolderRecipes(folderId);
        renderFolders();
        renderLists();
      };
      cancelSelect.onclick = () => {
        selectSheet.classList.remove('open');
        selectSheet.setAttribute('aria-hidden','true');
      };
      selectSheet.classList.add('open');
      selectSheet.setAttribute('aria-hidden','false');
    }

    // --- Init ---
    (async function init(){
      try{ db = await openDB(); }catch(e){ console.warn('DB failed', e); }
      recipes = loadRecipes();
      folders = loadFolders();
      lists = loadLists();

      renderList();
      updateNowLine();
    })();
  
// --- Add to Existing List selection sheet ---
let pendingAppendSections = []; // not strictly used; we pass sections directly
function openAddToListSheet(sections){
  const sheet = document.getElementById('addToListSheet');
  const listEl = document.getElementById('addToListChoices');
  const cancel = document.getElementById('addToListCancel');
  if (!sheet || !listEl) return;
  listEl.innerHTML = '';
  if (!lists || !lists.length){
    const li = document.createElement('li'); li.className='subtle'; li.style.padding='8px 4px'; li.textContent='No lists yet.'; listEl.appendChild(li);
  } else {
    for (const L of lists){
      const li = document.createElement('li');
      li.className = 'row';
      li.innerHTML = `
        <div class="content">
          <div class="name" style="font-weight:700;">${escapeHTML(L.name||'Untitled')}</div>
          <div class="meta">$${((L.items||[]).reduce((s,it)=> s + Number(it.price||0), 0)).toFixed(2)} ‚Ä¢ ${(L.items||[]).filter(it => !it || it.type !== 'section').length} items</div>
          <button class="btn" data-append="${L.id}">Add Here</button>
        </div>`;
      li.querySelector('[data-append]').addEventListener('click', () => {
        const target = lists.find(x => x.id === L.id);
        if (!target) return;
        const arr = sections || [];
        for (const sec of arr){
          target.items = target.items || [];
          target.items.push({ type:'section', note: sec.note, addedAt: Date.now() });
          for (const it of sec.items){
            target.items.push({ text: it.text, price: Number(it.price)||0, done:false });
          }
        }
        saveLists(lists);
        renderLists();
        sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true');
        openListView(L.id);
      });
      listEl.appendChild(li);
    }
  }
  if (cancel){ cancel.onclick = () => { sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); }; }
  sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false');
}
</script>
<script>
// Fix: pressing Enter in the Steps input should add a step (not submit form or affect chips)
(function(){
  const stepInput = document.getElementById('stepInput');
  if (stepInput){
    stepInput.addEventListener('keydown', function(e){
      if (e.key === 'Enter'){
        e.preventDefault();
        try{ window.stepsBuilder && stepsBuilder.add(); }catch{}
      }
    });
  }
})();
</script></body>
</html>
